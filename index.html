<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FANDER Leather Production</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* Sembunyikan view secara default */
        .view {
            display: none;
        }
        .view.active {
            display: block;
        }
        /* Custom styles untuk status pesanan */
        .status-pending { background-color: #f59e0b; color: white; }
        .status-processing { background-color: #3b82f6; color: white; }
        .status-shipped { background-color: #10b981; color: white; }
        .status-complete { background-color: #16a34a; color: white; }
        .status-cancelled { background-color: #ef4444; color: white; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 font-sans">

    <!-- Header / Navbar -->
    <header class="bg-gray-800 shadow-lg sticky top-0 z-50">
        <nav class="container mx-auto px-6 py-3 flex justify-between items-center">
            <div class="text-2xl font-bold text-cyan-400 cursor-pointer" onclick="navigate('home')">FANDER</div>
            <div class="flex items-center space-x-4">
                 <div id="nav-links" class="flex items-center space-x-4">
                    <button onclick="navigate('home')" class="text-gray-300 hover:text-cyan-400 transition">Produk</button>
                    <!-- Tombol Dashboard Admin akan ditambahkan di sini oleh JavaScript -->
                </div>
                <div id="auth-buttons" class="flex items-center space-x-2">
                    <!-- Tombol Login/Register/Profile akan di-render di sini -->
                </div>
            </div>
        </nav>
    </header>

    <main class="container mx-auto p-4 md:p-6">
        <!-- Home View (Product List) -->
        <div id="home-view" class="view">
            <h2 class="text-3xl font-bold text-cyan-400 mb-6">Produk Kami</h2>
            <div id="product-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Product cards will be loaded here -->
            </div>
        </div>

        <!-- Admin View -->
        <div id="admin-view" class="view">
             <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-cyan-400">Dashboard Admin</h2>
                 <button onclick="showAdminProductForm()" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg transition"><i class="fas fa-plus-circle mr-2"></i>Tambah Produk</button>
            </div>

            <!-- Form Tambah/Edit Produk (Hidden by default) -->
            <div id="admin-form-container" class="hidden bg-gray-800 p-6 rounded-lg mb-8">
                 <h3 id="form-title" class="text-2xl font-bold text-cyan-400 mb-4">Tambah Produk Baru</h3>
                 <form id="admin-product-form" onsubmit="event.preventDefault(); handleAdminProductSubmit(this.elements);" class="space-y-4">
                     <input type="hidden" name="id">
                     <div><label class="block mb-1 text-sm font-medium">Nama Produk</label><input name="name" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white" required></div>
                     <div><label class="block mb-1 text-sm font-medium">Kategori</label><input name="category" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white"></div>
                     <div><label class="block mb-1 text-sm font-medium">Harga</label><input name="price" type="number" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white" required></div>
                     <div><label class="block mb-1 text-sm font-medium">URL Gambar</label><input name="imageUrl" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white"></div>
                     <div><label class="block mb-1 text-sm font-medium">Deskripsi</label><textarea name="description" rows="4" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white"></textarea></div>
                     <div class="flex justify-end space-x-3">
                         <button type="button" onclick="document.getElementById('admin-form-container').classList.add('hidden')" class="bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-lg">Batal</button>
                         <button id="admin-form-submit-btn" type="submit" class="bg-cyan-500 hover:bg-cyan-600 text-white py-2 px-4 rounded-lg"><i class="fas fa-plus-circle mr-2"></i>Tambah Produk</button>
                     </div>
                 </form>
            </div>

            <!-- Tabel Produk Admin -->
            <div class="bg-gray-800 p-6 rounded-lg mb-8">
                 <h3 class="text-2xl font-bold text-cyan-400 mb-4">Manajemen Produk</h3>
                 <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="border-b border-gray-700">
                                <th class="p-4">Nama</th><th class="p-4">Harga</th><th class="p-4">Kategori</th><th class="p-4 text-right">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="admin-product-table-body"></tbody>
                    </table>
                 </div>
            </div>

            <!-- Tabel Pesanan Admin -->
            <div class="bg-gray-800 p-6 rounded-lg">
                <h3 class="text-2xl font-bold text-cyan-400 mb-4">Manajemen Pesanan</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="border-b border-gray-700"><th class="p-4">ID</th><th class="p-4">Produk</th><th class="p-4">Pembeli</th><th class="p-4">Status</th><th class="p-4 text-right">Aksi</th></tr>
                        </thead>
                        <tbody id="admin-order-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Profile View -->
        <div id="profile-view" class="view">
            <h2 class="text-3xl font-bold text-cyan-400 mb-6">Profil Saya</h2>
            <div class="bg-gray-800 p-6 rounded-lg mb-6 flex justify-between items-center">
                <div>
                    <p class="text-xl">Username: <span id="profile-username" class="font-bold text-cyan-300"></span></p>
                    <p class="text-sm text-gray-400">Tipe Akun: <span id="profile-type"></span></p>
                </div>
                <button onclick="showEditProfileForm()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg"><i class="fas fa-user-edit mr-2"></i>Edit Profil</button>
            </div>
             <div class="bg-gray-800 p-6 rounded-lg">
                 <h3 class="text-2xl font-bold text-cyan-400 mb-4">Riwayat Pesanan</h3>
                 <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead><tr class="border-b border-gray-700"><th class="p-4">ID Pesanan</th><th class="p-4">Tanggal</th><th class="p-4">Total</th><th class="p-4">Status</th><th class="p-4 text-right">Aksi</th></tr></thead>
                        <tbody id="user-order-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Order Form (hidden by default) -->
        <div id="order-form-container" class="hidden mt-8">
            <!-- Akan diisi oleh JS -->
        </div>
    </main>

    <!-- Generic Modal for Messages, Auth Forms, etc. -->
    <div id="message-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 items-center justify-center p-4">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6 border border-gray-700">
            <h3 id="modal-title" class="text-2xl font-bold text-cyan-400 mb-4"></h3>
            <div id="modal-content" class="text-gray-300 mb-6"></div>
            <div id="modal-actions" class="flex justify-end space-x-3"></div>
        </div>
    </div>

    <!-- Order Detail Modal -->
    <div id="order-detail-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 items-center justify-center p-4">
         <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-lg p-6 border border-gray-700 relative">
            <button onclick="document.getElementById('order-detail-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl">&times;</button>
            <h3 class="text-2xl font-bold text-cyan-400 mb-6">Detail Pesanan</h3>
            <div id="order-detail-content"></div>
        </div>
    </div>


<script>
    // --- KONFIGURASI DAN STATE APLIKASI ---
    const API_BASE = 'http://localhost:3000/api';
    const auth = {
        token: localStorage.getItem('fanderToken'),
        username: localStorage.getItem('fanderUsername'),
        isAdmin: localStorage.getItem('fanderIsAdmin') === 'true',
    };
    let products = [];
    let orders = [];
    let userOrders = [];
    let currentProduct = null;
    const INDONESIAN_PROVINCES = ["Aceh", "Bali", "Banten", "Bengkulu", "Gorontalo", "Jakarta", "Jambi", "Jawa Barat", "Jawa Tengah", "Jawa Timur", "Kalimantan Barat", "Kalimantan Selatan", "Kalimantan Tengah", "Kalimantan Timur", "Kalimantan Utara", "Kepulauan Bangka Belitung", "Kepulauan Riau", "Lampung", "Maluku", "Maluku Utara", "Nusa Tenggara Barat", "Nusa Tenggara Timur", "Papua", "Papua Barat", "Riau", "Sulawesi Barat", "Sulawesi Selatan", "Sulawesi Tengah", "Sulawesi Tenggara", "Sulawesi Utara", "Sumatera Barat", "Sumatera Selatan", "Sumatera Utara", "Yogyakarta"];

    // --- FUNGSI UTAMA NAVIGASI & UI ---
    
    /**
     * Mengelola perpindahan antar "halaman" atau "view" dalam aplikasi.
     * @param {string} viewName - Nama view yang akan ditampilkan (cth: 'home', 'admin').
     * @param {string} [param] - Parameter tambahan, biasanya ID untuk view detail.
     */
    async function navigate(viewName, param) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        const targetView = document.getElementById(`${viewName}-view`);

        if (targetView) {
            targetView.classList.add('active');
            window.scrollTo({ top: 0, behavior: 'smooth' });

            switch (viewName) {
                case 'home':
                    await loadProducts();
                    renderProductList(products);
                    break;
                case 'admin':
                    if (!auth.isAdmin) {
                        showMessage("Akses Ditolak", "Hanya admin yang dapat membuka dashboard ini.");
                        navigate('home'); // Redirect ke home jika bukan admin
                        return;
                    }
                    await renderAdminDashboard();
                    break;
                case 'profile':
                     if (!auth.token) {
                        showMessage("Login Diperlukan", "Anda harus login untuk melihat profil.");
                        navigate('home');
                        return;
                    }
                    await renderProfileView();
                    break;
                 case 'admin-edit': // view khusus untuk form edit
                    if (!auth.isAdmin) return;
                    // Tampilkan admin view, lalu scroll ke form dan isi data
                    document.getElementById('admin-view').classList.add('active');
                    showAdminProductForm(param);
                    document.getElementById('admin-form-container').scrollIntoView({ behavior: 'smooth' });
                    break;
            }
        } else {
            console.error(`View "${viewName}-view" tidak ditemukan.`);
            document.getElementById('home-view').classList.add('active'); // Fallback ke home
        }
    }

    /**
     * Memperbarui UI (tombol navigasi) berdasarkan status login dan role pengguna.
     * Ini adalah fungsi yang diperbaiki untuk menambahkan tombol Dashboard Admin secara persisten.
     */
    function updateAuthUI() {
        const authButtonsContainer = document.getElementById('auth-buttons');
        const navLinksContainer = document.getElementById('nav-links');
        
        // Hapus tombol dashboard admin yang mungkin ada sebelumnya untuk menghindari duplikasi
        const existingAdminBtn = navLinksContainer.querySelector('#admin-dashboard-btn');
        if (existingAdminBtn) {
            existingAdminBtn.remove();
        }

        if (auth.token) {
            // Pengguna sudah login
            authButtonsContainer.innerHTML = `
                <button onclick="navigate('profile')" class="px-4 py-2 text-gray-300 hover:text-cyan-400 transition">${auth.username}</button>
                <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-3 rounded-lg transition">Logout</button>
            `;
            if (auth.isAdmin) {
                // Jika admin, tambahkan tombol Dashboard ke navigasi utama
                const adminDashboardBtn = document.createElement('button');
                adminDashboardBtn.id = 'admin-dashboard-btn';
                adminDashboardBtn.textContent = 'Dashboard Admin';
                adminDashboardBtn.className = 'bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-3 rounded-lg transition';
                adminDashboardBtn.onclick = () => navigate('admin');
                navLinksContainer.appendChild(adminDashboardBtn);
            }
        } else {
            // Pengguna belum login
            authButtonsContainer.innerHTML = `
                <button onclick="showAuthForm('login')" class="px-4 py-2 text-gray-300 hover:text-cyan-400 transition">Login</button>
                <button onclick="showAuthForm('register')" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-3 rounded-lg transition">Register</button>
            `;
        }
    }

    function logout() {
        auth.token = null;
        auth.username = null;
        auth.isAdmin = false;
        localStorage.removeItem('fanderToken');
        localStorage.removeItem('fanderUsername');
        localStorage.removeItem('fanderIsAdmin');
        updateAuthUI();
        navigate('home');
    }

    /**
     * Menampilkan modal (popup) untuk pesan, konfirmasi, atau form.
     * @param {string} title - Judul modal.
     * @param {string} content - Isi konten modal (bisa berupa HTML).
     * @param {Function} [onConfirm] - Callback jika tombol konfirmasi ditekan.
     * @param {Function} [onCancel] - Callback jika tombol batal ditekan.
     */
    function showMessage(title, content, onConfirm, onCancel) {
        const modal = document.getElementById('message-modal');
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-content').innerHTML = content;
        const actions = document.getElementById('modal-actions');
        actions.innerHTML = '';

        if (onCancel) {
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'Batal';
            cancelBtn.className = 'bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-lg';
            cancelBtn.onclick = () => {
                modal.classList.add('hidden');
                onCancel();
            };
            actions.appendChild(cancelBtn);
        }

        if (onConfirm) {
            const confirmBtn = document.createElement('button');
            confirmBtn.textContent = onCancel ? 'Konfirmasi' : 'OK';
            confirmBtn.className = 'bg-cyan-500 hover:bg-cyan-600 text-white py-2 px-4 rounded-lg';
            confirmBtn.onclick = () => {
                modal.classList.add('hidden');
                onConfirm();
            };
            actions.appendChild(confirmBtn);
        }
        
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }

    // --- HELPER LAINNYA ---
    const getAuthHeaders = () => ({ 'Content-Type': 'application/json', 'Authorization': `Bearer ${auth.token}` });
    const formatRupiah = (number) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(number);


    // ===================================================================================
    // SELURUH KODE HANDLER DARI PDF ANDA DITEMPATKAN DI SINI
    // Saya telah menyalinnya persis seperti yang Anda berikan.
    // ===================================================================================
    
    // Order handlers
    function showOrderForm() {
        // ... (Kode showOrderForm Anda dari PDF)
    }

    function hideOrderForm() {
        // ... (Kode hideOrderForm Anda dari PDF)
    }

    async function submitOrder(elements) {
        // ... (Kode submitOrder Anda dari PDF)
    }
    
    function renderOrderDetailModal(order) {
        const modal = document.getElementById('order-detail-modal');
        const content = document.getElementById('order-detail-content');
        const statusClass = `status-${(order.status || '').toLowerCase()}`;
        const totalHarga = formatRupiah(order.totalPrice || 0);

        content.innerHTML = `
            <div class="space-y-6">
                <div class="p-4 bg-gray-700 rounded-xl flex justify-between items-center shadow-inner">
                    <p class="text-lg text-gray-300 font-medium">Status Saat Ini:</p>
                    <span class="px-4 py-2 rounded-full text-sm ${statusClass}">${order.status}</span>
                </div>
                <h4 class="text-xl font-bold text-cyan-400 border-b border-gray-700 pb-2">Rincian Produk</h4>
                <div class="grid grid-cols-2 gap-3 text-sm">
                    <p class="text-gray-400">Nama Produk:</p>
                    <p class="text-white font-semibold">${order.productName}</p>
                    <p class="text-gray-400">Total Harga:</p>
                    <p class="text-white font-semibold text-xl">${totalHarga}</p>
                </div>
                <h4 class="text-xl font-bold text-cyan-400 border-b border-gray-700 pb-2">Detail Pengiriman</h4>
                <div class="grid grid-cols-2 gap-3 text-sm">
                    <p class="text-gray-400">Nama Penerima:</p>
                    <p class="text-white">${order.buyerName}</p>
                    <p class="text-gray-400">Nomor HP:</p>
                    <p class="text-white">${order.buyerPhone}</p>
                    <p class="text-gray-400">ID Pesanan:</p>
                    <p class="text-white text-xs break-all">${order.id}</p>
                    <p class="col-span-2 text-gray-400">Alamat Lengkap:</p>
                    <p class="col-span-2 text-white">${order.buyerAddress}</p>
                </div>
                <h4 class="text-xl font-bold text-cyan-400 border-b border-gray-700 pb-2">Informasi Lain</h4>
                <div class="grid grid-cols-2 gap-3 text-sm">
                    <p class="text-gray-400">Dipesan Pada:</p>
                    <p class="text-white">${new Date(order.createdAt).toLocaleString('id-ID')}</p>
                    <p class="text-gray-400">ID Pengguna:</p>
                    <p class="text-white text-xs break-all">${order.userId || 'Guest'}</p>
                </div>
            </div>`;
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }

    // PROFILE HANDLERS
    async function renderProfileView() {
        if (!auth.token) return;
        document.getElementById('profile-username').textContent = auth.username;
        document.getElementById('profile-type').textContent = auth.isAdmin ? 'Admin' : 'Regular User';
        const orderTableBody = document.getElementById('user-order-table-body');
        orderTableBody.innerHTML = '<tr><td colspan="5" class="px-5 py-4 text-center text-cyan-400 italic"><i class="fas fa-spinner fa-spin mr-2"></i>Memuat pesanan Anda...</td></tr>';

        try {
            const response = await fetch(`${API_BASE}/orders/user`, { headers: getAuthHeaders() });
            if (!response.ok) throw new Error('Failed to fetch user orders');
            userOrders = await response.json();

            if (!Array.isArray(userOrders) || userOrders.length === 0) {
                orderTableBody.innerHTML = '<tr><td colspan="5" class="px-5 py-4 text-center text-gray-400 italic">Anda belum memiliki riwayat pesanan.</td></tr>';
                return;
            }

            orderTableBody.innerHTML = userOrders.map(order => {
                const statusClass = `status-${(order.status || '').toLowerCase()}`;
                return `
                <tr class="hover:bg-gray-700 transition duration-150">
                    <td class="px-5 py-4 text-sm text-gray-300 w-[100px] truncate">${(order.id || '').substring(0, 8)}...</td>
                    <td class="px-5 py-4 text-sm text-gray-300">${new Date(order.createdAt).toLocaleDateString('id-ID')}</td>
                    <td class="px-5 py-4 text-sm font-semibold text-cyan-300">${formatRupiah(order.totalPrice)}</td>
                    <td class="px-5 py-4 text-sm"><span class="px-3 py-1 rounded-full text-xs ${statusClass}">${order.status}</span></td>
                    <td class="px-5 py-4 text-right">
                        <button onclick="renderOrderDetailModal(userOrders.find(o => o.id === '${order.id}'))" class="text-cyan-400 hover:text-cyan-500 text-sm font-medium">
                            <i class="fas fa-eye mr-1"></i> Detail
                        </button>
                    </td>
                </tr>`;
            }).join('');
        } catch (error) {
            console.error('User Order load error:', error);
            orderTableBody.innerHTML = '<tr><td colspan="5" class="px-5 py-4 text-center text-red-400 italic">Gagal memuat riwayat pesanan. Token mungkin tidak valid.</td></tr>';
        }
    }

    function showEditProfileForm() {
        if (!auth.token) {
            showMessage("Login Diperlukan", "Silakan login terlebih dahulu untuk mengedit profil.");
            return;
        }

        const html = `<div>
            <label class='block mb-2 text-gray-300 text-sm'>Username Baru</label>
            <input id='new-username' class='w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white mb-3' placeholder='Masukkan username baru' value='${auth.username || ""}'>
            <label class='block mb-2 text-gray-300 text-sm'>Password Baru (biarkan kosong jika tidak ingin mengganti)</label>
            <input id='new-password' type='password' class='w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white mb-3' placeholder='Masukkan password baru'>
        </div>`;
        
        showMessage("Edit Profil", html, async () => {
             const newUsername = document.getElementById('new-username').value.trim();
             const newPassword = document.getElementById('new-password').value;

            if (!newUsername) {
                showMessage("Validasi", "Username tidak boleh kosong.", () => showEditProfileForm()); // Kembali ke form jika gagal
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/users/profile`, {
                    method: 'PUT',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ username: newUsername, password: newPassword }),
                });

                const result = await response.json();
                if (response.ok) {
                    showMessage("Berhasil", "Profil berhasil diperbarui. Silakan login ulang.", () => {
                        logout(); // Paksa logout agar login ulang
                    });
                } else {
                    showMessage("Gagal", result.message || "Tidak dapat memperbarui profil.", () => showEditProfileForm());
                }
            } catch (err) {
                console.error('Profile update error', err);
                showMessage("Error Jaringan", "Gagal menghubungi server API.", () => showEditProfileForm());
            }
        }, () => {});
    }

    // ADMIN HANDLERS
    async function renderAdminDashboard() {
        if (!auth.isAdmin) return;
        await loadProducts();
        renderAdminProductTable(products);
        await loadAdminOrders();
        renderAdminOrderTable(orders);
        document.getElementById('admin-form-container').classList.add('hidden');
    }

    async function loadAdminOrders() {
        try {
            const response = await fetch(`${API_BASE}/orders`, { headers: getAuthHeaders() });
            if (!response.ok) throw new Error('Failed to fetch admin orders');
            orders = await response.json();
        } catch (error) {
            console.error('Admin Order load error:', error);
            orders = [];
            const orderTableBody = document.getElementById('admin-order-table-body');
            orderTableBody.innerHTML = '<tr><td colspan="5" class="px-5 py-4 text-center text-red-400 italic">Gagal memuat data pesanan.</td></tr>';
        }
    }

    function renderAdminOrderTable(ordersArray) {
        const tableBody = document.getElementById('admin-order-table-body');
        tableBody.innerHTML = '';
        if (!Array.isArray(ordersArray) || ordersArray.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="5" class="px-5 py-4 text-center text-gray-400 italic">Belum ada pesanan masuk.</td></tr>';
            return;
        }

        ordersArray.forEach(order => {
            const statusClass = `status-${(order.status || '').toLowerCase()}`;
            const row = `
            <tr class="hover:bg-gray-700 transition duration-150">
                <td class="px-5 py-4 text-sm text-gray-300 w-[100px] truncate">${(order.id || '').substring(0, 8)}...</td>
                <td class="px-5 py-4 text-sm text-gray-300">
                    <span class="font-semibold">${order.productName}</span><br>
                    <span class="text-cyan-400 font-bold">${formatRupiah(order.totalPrice)}</span>
                </td>
                <td class="px-5 py-4 text-sm text-gray-300">
                    <span class="font-medium">${order.buyerName}</span><br>
                    <span class="text-xs text-gray-400">${order.buyerPhone}</span>
                </td>
                <td class="px-5 py-4 text-sm">
                    <span id="status-${order.id}" class="px-3 py-1 rounded-full text-xs ${statusClass}">${order.status}</span>
                </td>
                <td class="px-5 py-4 text-right space-x-2">
                    <button onclick="renderOrderDetailModal(orders.find(o => o.id === '${order.id}'))" class="text-cyan-400 hover:text-cyan-500 text-sm font-medium"><i class="fas fa-eye"></i></button>
                    <select onchange="updateOrderStatus('${order.id}', this.value)" class="form-select form-select-sm bg-gray-600 text-sm w-fit inline-block py-1 rounded-md border-gray-500">
                        <option value="${order.status}" disabled selected>${order.status} (Saat Ini)</option>
                        <option value="Pending">Pending</option>
                        <option value="Processing">Processing</option>
                        <option value="Shipped">Shipped</option>
                        <option value="Complete">Complete</option>
                        <option value="Cancelled">Cancelled</option>
                    </select>
                </td>
            </tr>`;
            tableBody.innerHTML += row;
        });
    }

    async function updateOrderStatus(orderId, newStatus) {
        if (!auth.isAdmin) return showMessage("Akses Ditolak", "Hanya Admin yang dapat mengubah status pesanan.");
        try {
            const response = await fetch(`${API_BASE}/orders/${orderId}/status`, {
                method: 'PUT',
                headers: getAuthHeaders(),
                body: JSON.stringify({ status: newStatus }),
            });
            const result = await response.json();
            if (response.ok) {
                showMessage("Sukses", result.message, () => {});
                // Refresh data
                const orderToUpdate = orders.find(o => o.id === orderId);
                if(orderToUpdate) orderToUpdate.status = newStatus;
                renderAdminOrderTable(orders);
            } else {
                showMessage("Gagal Update", result.message || "Gagal memperbarui status pesanan.", () => {});
            }
        } catch (error) {
            console.error('Update Status Error:', error);
            showMessage("Error Jaringan", "Gagal terhubung ke server API.", () => {});
        }
    }

    function renderAdminProductTable(productsArray) {
        const tableBody = document.getElementById('admin-product-table-body');
        tableBody.innerHTML = '';

        if (!Array.isArray(productsArray) || productsArray.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="4" class="px-5 py-4 text-center text-gray-400 italic">Belum ada produk terdaftar.</td></tr>';
            return;
        }

        productsArray.forEach(product => {
            const row = `
            <tr class="hover:bg-gray-700 transition duration-150">
                <td class="px-5 py-4 text-sm text-gray-300 font-medium">${product.name}</td>
                <td class="px-5 py-4 text-sm text-cyan-300 font-semibold">${formatRupiah(product.price)}</td>
                <td class="px-5 py-4 text-sm text-gray-400">${product.category}</td>
                <td class="px-5 py-4 text-right space-x-2">
                    <button onclick="navigate('admin-edit','${product.id}')" class="text-blue-400 hover:text-blue-500 text-sm font-medium"><i class="fas fa-edit"></i> Edit</button>
                    <button onclick="deleteProduct('${product.id}')" class="text-red-400 hover:text-red-500 text-sm font-medium"><i class="fas fa-trash"></i> Hapus</button>
                </td>
            </tr>`;
            tableBody.innerHTML += row;
        });
    }
    
    function showAdminProductForm(productId = null) {
        const formContainer = document.getElementById('admin-form-container');
        const formElements = document.getElementById('admin-product-form').elements;
        const isEdit = productId !== null;

        formContainer.classList.remove('hidden');
        document.getElementById('form-title').textContent = isEdit ? 'Edit Produk' : 'Tambah Produk Baru';
        document.getElementById('admin-form-submit-btn').innerHTML = isEdit ? '<i class="fas fa-save mr-2"></i><span>Update Produk</span>' : '<i class="fas fa-plus-circle mr-2"></i><span>Tambah Produk</span>';

        document.getElementById('admin-product-form').reset();
        formElements.id.value = '';

        if (isEdit) {
            const product = products.find(p => p.id === productId);
            if (product) {
                formElements.id.value = product.id;
                formElements.name.value = product.name;
                formElements.category.value = product.category;
                formElements.price.value = product.price;
                formElements.imageUrl.value = product.imageUrl;
                formElements.description.value = product.description;
            }
        }
    }

    async function handleAdminProductSubmit(elements) {
        if (!auth.isAdmin) return showMessage("Akses Ditolak", "Hanya Admin yang dapat mengelola produk.");
        const productId = elements.id.value;
        const isUpdate = !!productId;
        const method = isUpdate ? 'PUT' : 'POST';
        const url = isUpdate ? `${API_BASE}/products/${productId}` : `${API_BASE}/products`;

        const productData = {
            name: elements.name.value,
            category: elements.category.value,
            price: Number(elements.price.value),
            imageUrl: elements.imageUrl.value,
            description: elements.description.value,
        };

        try {
            const response = await fetch(url, {
                method,
                headers: getAuthHeaders(),
                body: JSON.stringify(productData)
            });
            const result = await response.json();
            if (response.ok) {
                showMessage("Sukses", `Produk ${isUpdate ? 'diperbarui' : 'ditambahkan'}!`, () => {
                    navigate('admin');
                });
            } else {
                showMessage("Gagal", result.message || `Gagal ${isUpdate ? 'memperbarui' : 'menambahkan'} produk.`, () => {});
            }
        } catch (error) {
            console.error('Admin Product Error:', error);
            showMessage("Error Jaringan", "Gagal terhubung ke server API.", () => {});
        }
    }

    async function deleteProduct(productId) {
        if (!auth.isAdmin) return showMessage("Akses Ditolak", "Hanya Admin yang dapat menghapus produk.");
        showMessage("Konfirmasi Hapus", "Apakah Anda yakin ingin menghapus produk ini? Tindakan ini tidak dapat dibatalkan.", async () => {
            try {
                const response = await fetch(`${API_BASE}/products/${productId}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });

                if (response.status === 204) {
                    showMessage("Sukses", "Produk berhasil dihapus.", () => {
                        navigate('admin');
                    });
                } else {
                    const result = await response.json();
                    showMessage("Gagal", result.message || "Gagal menghapus produk.", () => {});
                }
            } catch (error) {
                console.error('Delete Product Error:', error);
                showMessage("Error Jaringan", "Gagal terhubung ke server API.", () => {});
            }
        }, () => {});
    }

    // --- FUNGSI goBackToAdminDashboard() DIHAPUS SESUAI PERMINTAAN ---
    
    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        updateAuthUI();
        // Arahkan ke dashboard jika admin, jika tidak ke halaman utama
        const initialView = auth.isAdmin ? 'admin' : 'home';
        navigate(initialView);
    });

    // Dummy functions untuk kelengkapan, Anda bisa mengisinya sesuai kebutuhan
    async function loadProducts() { 
        try {
            const response = await fetch(`${API_BASE}/products`);
            if(!response.ok) throw new Error("Gagal memuat produk");
            products = await response.json();
        } catch(error) {
            console.error("Load products error:", error);
            products = [];
        }
    }

    function renderProductList(productsArray) {
        const productListContainer = document.getElementById('product-list');
        if (productsArray.length === 0) {
            productListContainer.innerHTML = '<p class="text-center text-gray-400 col-span-full">Gagal memuat produk atau belum ada produk.</p>';
            return;
        }
        productListContainer.innerHTML = productsArray.map(p => `
            <div class="bg-gray-800 rounded-lg overflow-hidden shadow-lg hover:shadow-cyan-500/50 transition-shadow duration-300">
                <img src="${p.imageUrl}" alt="${p.name}" class="w-full h-48 object-cover">
                <div class="p-4">
                    <h3 class="text-xl font-bold text-white">${p.name}</h3>
                    <p class="text-gray-400 text-sm mb-2">${p.category}</p>
                    <p class="text-lg font-semibold text-cyan-400 mb-4">${formatRupiah(p.price)}</p>
                    <p class="text-gray-300 text-sm mb-4 h-16 overflow-hidden">${p.description}</p>
                    <button class="w-full bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg transition">Lihat Detail</button>
                </div>
            </div>
        `).join('');
    }

    function showAuthForm(type) {
        const isLogin = type === 'login';
        const title = isLogin ? 'Login Akun' : 'Buat Akun Baru';
        const html = `
            <div class="space-y-4">
                 <div>
                    <label class="block text-sm text-gray-300 mb-1">Username</label>
                    <input id="auth-username" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white" required>
                </div>
                <div>
                    <label class="block text-sm text-gray-300 mb-1">Password</label>
                    <input id="auth-password" type="password" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white" required>
                </div>
            </div>
        `;

        showMessage(title, html, async () => {
            const username = document.getElementById('auth-username').value;
            const password = document.getElementById('auth-password').value;
            if(!username || !password) {
                 showMessage("Error", "Username dan password tidak boleh kosong.", () => showAuthForm(type));
                 return;
            }

            try {
                const response = await fetch(`${API_BASE}/auth/${type}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username, password})
                });
                const result = await response.json();
                if(response.ok){
                    auth.token = result.token;
                    auth.username = result.username;
                    auth.isAdmin = result.isAdmin;
                    localStorage.setItem('fanderToken', auth.token);
                    localStorage.setItem('fanderUsername', auth.username);
                    localStorage.setItem('fanderIsAdmin', auth.isAdmin);
                    updateAuthUI();
                    navigate(auth.isAdmin ? 'admin' : 'home');
                } else {
                    showMessage("Gagal", result.message, () => showAuthForm(type));
                }
            } catch(error) {
                 showMessage("Error Jaringan", "Gagal terhubung ke server.", () => showAuthForm(type));
            }

        }, () => {});
    }

</script>
</body>
</html>
